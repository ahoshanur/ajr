<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A.J.R Parcel Branch List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f8f9fa;
    }
    .title-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .link-btn {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 1px solid #007BFF;
      background: white;
      color: #007BFF;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
    }
    .link-btn:hover {
      background: #007BFF;
      color: white;
    }
    h1 {
      font-size: 2rem;
      margin: 0;
    }
    h2 {
      background: #007BFF;
      color: white;
      padding: 0.5rem;
      border-radius: 5px;
    }
    .branch {
      background: white;
      border: 1px solid #ddd;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 5px;
    }
    .copy-btn {
      margin-top: 0.5rem;
      padding: 0.3rem 0.6rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 3px;
    }
    .top-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    #search {
      flex-grow: 1;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #regionButton {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 1px solid #007BFF;
      background: white;
      color: #007BFF;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
    }
    #regionMenu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 0.2rem;
      display: none;
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #regionMenu div {
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    #regionMenu div:hover {
      background: #007BFF;
      color: white;
    }
  </style>
</head>
<body>

  <div class="title-bar">
    <a href="https://www.facebook.com/ahoshanur" target="_blank" class="link-btn">B</a>
    <h1>A.J.R Parcel Branch List</h1>
  </div>

  <div class="top-controls">
    <input type="text" id="search" placeholder="Search branches..." />
    <div style="position: relative;">
      <button id="regionButton">R</button>
      <div id="regionMenu"></div>
    </div>
  </div>

  <div id="branches"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuzzysort@2.0.4/fuzzysort.min.js"></script>

  <script>
    const csvUrl = 'https://ahoshanur.github.io/ajr/parcel-branch.csv';
    let allBranches = [];
    let allRegions = new Set();
    let selectedRegion = 'All';

    function renderRegionMenu() {
      const menu = document.getElementById('regionMenu');
      menu.innerHTML = '';
      const regions = ['All', ...Array.from(allRegions).sort()];
      regions.forEach(region => {
        const div = document.createElement('div');
        div.textContent = region;
        div.onclick = () => {
          selectedRegion = region;
          document.getElementById('regionButton').textContent = `R`;
          menu.style.display = 'none';
          const query = document.getElementById('search').value.trim();
          renderBranches(allBranches, query, selectedRegion);
        };
        menu.appendChild(div);
      });
    }

    function renderBranches(data, query = '', region = 'All') {
      const container = document.getElementById('branches');
      container.innerHTML = '';

      const grouped = {};
      data.forEach(branch => {
        const region = branch.region.trim();
        if (!grouped[region]) grouped[region] = [];
        grouped[region].push(branch);
      });

      Object.keys(grouped).forEach(r => {
        if (region !== 'All' && r !== region) return;

        let branches = grouped[r];

        if (query) {
          const queryWords = query.trim().split(/\s+/);
          branches = branches.filter(branch => {
            const target = [branch.office, branch.address, branch.phone1, branch.phone2, branch.search].join(' ');
            return queryWords.every(word => fuzzysort.single(word, target));
          });
        }

        if (branches.length === 0) return;

        const regionHeading = document.createElement('h2');
        regionHeading.textContent = r;
        container.appendChild(regionHeading);

        branches.forEach(branch => {
          const div = document.createElement('div');
          div.className = 'branch';

          const lines = [
            branch.office,
            branch.address,
            branch.phone1,
            branch.phone2
          ];

          lines.forEach(line => {
            const p = document.createElement('p');
            p.textContent = line;
            div.appendChild(p);
          });

          const button = document.createElement('button');
          button.className = 'copy-btn';
          button.textContent = 'Copy Branch Details';
          button.onclick = () => {
            const text = lines.join('\n');
            navigator.clipboard.writeText(text).then(() => {
              button.textContent = 'Copied!';
              setTimeout(() => (button.textContent = 'Copy Branch Details'), 1500);
            });
          };
          div.appendChild(button);

          container.appendChild(div);
        });
      });
    }

    function loadCSV() {
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          allBranches = results.data.filter(row => row.office && row.region);
          allBranches.forEach(row => allRegions.add(row.region.trim()));
          renderRegionMenu();
          renderBranches(allBranches);
        }
      });
    }

    let debounceTimer;
    document.getElementById('search').addEventListener('input', e => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = e.target.value.trim();
        renderBranches(allBranches, query, selectedRegion);
      }, 200);
    });

    document.getElementById('regionButton').addEventListener('click', () => {
      const menu = document.getElementById('regionMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    document.addEventListener('click', e => {
      if (!document.getElementById('regionButton').contains(e.target) &&
          !document.getElementById('regionMenu').contains(e.target)) {
        document.getElementById('regionMenu').style.display = 'none';
      }
    });

    loadCSV();
  </script>

</body>
</html>
